name: Build Pipeline

on:
  workflow_dispatch:
  push:
    branches:
      - main

env:
  PYTHON_VERSION: '3.10'

jobs:
  build:
    runs-on: ubuntu-latest
    
    env:
      MLFLOW_TRACKING_URI: ${{ vars.MLFLOW_URL }}
      AZURE_STORAGE_CONNECTION_STRING: ${{ secrets.AZURE_STORAGE_CONNECTION_STRING }}
      EXPERIMENT_NAME: ${{ vars.EXPERIMENT_NAME }}
      MODEL_NAME: ${{ vars.MODEL_NAME }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Generate run name
      id: run_name
      run: echo "RUN_NAME=build-$(date +'%Y%m%d-%H%M%S')" >> $GITHUB_OUTPUT
    
    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Download dataset
      run: |
        python scripts/download_data.py
    
    - name: Train and save model
      run: |
        python src/main.py
    
    - name: Save run_id
      run: |
        echo "Model trained. Run ID saved to run_id.txt"
        cat run_id.txt
    
    - name: Run integration tests
      continue-on-error: true
      run: |
        pytest tests/test_data_loader.py tests/test_model.py -v
    
    - name: Run performance tests
      continue-on-error: true
      run: |
        pytest tests/test_evaluate.py -v
    
    - name: Register model
      run: |
        export RUN_ID=$(cat run_id.txt)
        python scripts/register_model.py
      env:
        RUN_ID: ${{ steps.run_name.outputs.RUN_NAME }}