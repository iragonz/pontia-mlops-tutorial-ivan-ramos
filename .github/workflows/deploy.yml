name: Deploy Pipeline

on:
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.10'
  MODEL_NAME: ${{ vars.MODEL_NAME }}
  MODEL_ALIAS: 'champion'
  AZURE_CONTAINER_NAME: 'model-api-ivan-ramos'
  IMAGE_NAME: 'adult-income-api'
  AZURE_REGION: 'eastus'

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
    
    - name: Log in to Azure Container Registry
      uses: docker/login-action@v2
      with:
        registry: ${{ secrets.ACR_NAME }}.azurecr.io
        username: ${{ secrets.ACR_USERNAME }}
        password: ${{ secrets.ACR_PASSWORD }}
    
    - name: Build Docker image
      run: |
        docker build -t ${{ secrets.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:latest \
          --build-arg MODEL_NAME=${{ env.MODEL_NAME }} \
          --build-arg MLFLOW_TRACKING_URI=${{ vars.MLFLOW_URL }} \
          .
    
    - name: Push Docker image to ACR
      run: |
        docker push ${{ secrets.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:latest
    
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: Deploy to Azure Container Instances
      run: |
        az container create \
          --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
          --name ${{ env.AZURE_CONTAINER_NAME }} \
          --image ${{ secrets.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:latest \
          --cpu 1 \
          --memory 2 \
          --registry-login-server ${{ secrets.ACR_NAME }}.azurecr.io \
          --registry-username ${{ secrets.ACR_USERNAME }} \
          --registry-password ${{ secrets.ACR_PASSWORD }} \
          --dns-name-label ${{ env.AZURE_CONTAINER_NAME }} \
          --ports 8000 \
          --environment-variables \
            MODEL_NAME=${{ env.MODEL_NAME }} \
            MODEL_ALIAS=${{ env.MODEL_ALIAS }} \
            MLFLOW_TRACKING_URI=${{ vars.MLFLOW_URL }} \
          --restart-policy Always
    
    - name: Get container info
      run: |
        az container show \
          --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
          --name ${{ env.AZURE_CONTAINER_NAME }} \
          --query "{FQDN:ipAddress.fqdn,ProvisioningState:provisioningState}" \
          --output table
    
    - name: Wait for container to be ready
      run: |
        echo "Waiting 30 seconds for container to start..."
        sleep 30
    
    - name: Test API health endpoint
      continue-on-error: true
      run: |
        FQDN=$(az container show \
          --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
          --name ${{ env.AZURE_CONTAINER_NAME }} \
          --query "ipAddress.fqdn" \
          --output tsv)
        
        echo "Testing API at http://${FQDN}:8000/health"
        curl -f http://${FQDN}:8000/health || echo "Health check failed"
    
    - name: Test API prediction endpoint
      continue-on-error: true
      run: |
        FQDN=$(az container show \
          --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
          --name ${{ env.AZURE_CONTAINER_NAME }} \
          --query "ipAddress.fqdn" \
          --output tsv)
        
        echo "Testing prediction at http://${FQDN}:8000/predict"
        curl -f -X POST http://${FQDN}:8000/predict \
          -H "Content-Type: application/json" \
          -d '{
            "age": 39,
            "workclass": "State-gov",
            "fnlwgt": 77516,
            "education": "Bachelors",
            "education_num": 13,
            "marital_status": "Never-married",
            "occupation": "Adm-clerical",
            "relationship": "Not-in-family",
            "race": "White",
            "sex": "Male",
            "capital_gain": 2174,
            "capital_loss": 0,
            "hours_per_week": 40,
            "native_country": "United-States"
          }' || echo "Prediction test failed"